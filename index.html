<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Code Detectives: The JetBrains Case Files — Full Course</title>
<style>
  :root{
    --jb-purple:#9146FF; --jb-purple-2:#6B2CFF;
    --jb-dark:#0E121A; --jb-mid:#1B2230; --jb-panel:#111827;
    --jb-text:#E5E7EB; --jb-sub:#9CA3AF; --jb-line:#2B3446;
    --ok:#22C55E; --warn:#F59E0B; --bad:#EF4444; --info:#60A5FA;
    --paper:#F5F7FA;
  }
  html,body{height:100%}
  body{margin:0;background:#2f3747;font-family: ui-sans-serif, system-ui, Segoe UI, Roboto, Helvetica, Arial, Apple Color Emoji, Segoe UI Emoji; color:var(--jb-text); overflow:hidden}
  .app{max-width:1160px;height:95vh;aspect-ratio:16/10;margin:auto;border-radius:22px;border:10px solid #9CA3AF;overflow:hidden;box-shadow:0 18px 60px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.05);background:
    radial-gradient(1200px 600px at 110% -10%,rgba(145,70,255,.22),transparent),
    radial-gradient(1200px 600px at -10% 110%,rgba(34,197,94,.14),transparent),
    linear-gradient(145deg,rgba(8,11,19,.95),rgba(25,32,47,.95))}
  .hidden{display:none!important}
  .row{display:grid;grid-template-columns:2fr 1fr;height:100%}
  .center{display:flex;align-items:center;justify-content:center}
  /* screens */
  #start,#end{background:linear-gradient(180deg,#E5E7EB,#F3F4F6); color:#111827}
  #start h1{font-size:3rem;margin:.25rem 0 0}
  #start p{color:#4B5563;margin:.5rem 0 1.5rem}
  #end h2{font-size:2.2rem;margin:.4rem 0}
  /* scene/panel */
  #scene{position:relative;background:#0B1020;overflow:hidden}
  #panel{background:rgba(255,255,255,.94);color:#111827;border-left:6px solid var(--jb-purple);padding:16px;display:flex;flex-direction:column;min-height:0;overflow:auto}
  .panel-head{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .panel-title{font-weight:800;color:#4f46e5}
  .panel-tag{background:#111827;color:#fff;border-radius:8px;padding:.2rem .55rem;font-size:.74rem}
  .panel-body{margin-top:.5rem}
  .box{background:#EEF2FF;border:1px solid #CBD5E1;border-radius:10px;padding:10px}
  .log{margin-top:8px}
  /* buttons */
  .btn{background:var(--jb-purple);color:#fff;border:none;border-radius:12px;padding:.85rem 1.5rem;font-weight:800;cursor:pointer;transition:filter .15s,transform .02s}
  .btn:hover{filter:brightness(1.07)}
  .btn:active{transform:translateY(1px)}
  .btn.secondary{background:#111827;border:1px solid #374151;color:#E5E7EB}
  /* choices */
  .choice{background:#fff;border:2px solid #9CA3AF;border-radius:10px;padding:.75rem;text-align:left;cursor:pointer;transition:background .15s,border-color .15s;display:block;width:100%}
  .choice:hover{border-color:var(--jb-purple);background:#EEF2FF}
  .choice.disabled{opacity:.55;cursor:not-allowed}
  .choice.incorrect{background:#FEE2E2;border-color:#FCA5A5;text-decoration:line-through}
  /* instruction / popup */
  #instruction{position:absolute;bottom:1rem;right:1rem;background:#FEF3C7;border:2px solid #F59E0B;border-radius:10px;padding:.45rem .6rem;font-weight:800;color:#78350F;opacity:.95;z-index:3}
  .overlay{position:absolute;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;z-index:40}
  .popup{background:#fff;border:2px solid #D1D5DB;border-radius:14px;box-shadow:0 12px 40px rgba(0,0,0,.4);max-width:720px;width:92%;color:#111827}
  .popup .hd{padding:.7rem .9rem;border-bottom:2px solid #E5E7EB;border-radius:12px 12px 0 0;font-weight:900}
  .popup .bd{padding:1rem .95rem;line-height:1.55}
  .popup .ft{padding:.85rem .95rem;background:#F9FAFB;border-radius:0 0 12px 12px;text-align:right}
  /* fade scene */
  .fade{position:absolute;inset:0;opacity:0;transition:opacity .55s ease}
  .fade.show{opacity:1}
  .scene-title{position:absolute;top:10px;left:50%;transform:translateX(-50%);color:#a5b4fc;font-weight:800;letter-spacing:.06em;z-index:2;font-size:.9rem;text-shadow:0 2px 6px rgba(0,0,0,.5)}
  /* Unit 734 */
  #unit-734{position:absolute;bottom:-6px;left:-340px;width:280px;height:320px;transition:all .8s cubic-bezier(.25,1,.5,1);z-index:3}
  #unit-734 .hover-idle{animation:hover 4s ease-in-out infinite}
  @keyframes hover{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
  .face{transition:opacity .2s ease}
  /* magnifier */
  .hot{position:absolute;cursor:pointer;z-index:4;transition:transform .15s}
  .hot:hover{transform:scale(1.08)}
  .hot svg{filter:drop-shadow(0 4px 10px rgba(0,0,0,.55))}
  /* typewriter */
  .tw::after{content:"|";animation:blink 1s step-end infinite}
  @keyframes blink{50%{opacity:0}}
  /* quiz list bullets */
  .list{margin:.25rem 0 .5rem 1.2rem}
</style>
</head>
<body>
  <div class="app">
    <!-- START -->
    <section id="start" class="center" style="height:100%;flex-direction:column;text-align:center;padding:18px">
      <h1>Code Detectives</h1>
      <p>The JetBrains Case Files</p>
      <button id="start-btn" class="btn" style="font-size:1.1rem">Open the First Case</button>
    </section>

    <!-- GAME -->
    <section id="game" class="hidden row">
      <div id="scene"></div>
      <aside id="panel"></aside>
    </section>

    <!-- END -->
    <section id="end" class="hidden center" style="flex-direction:column;padding:20px;text-align:center">
      <h2>All Cases Closed</h2>
      <div id="end-msg" style="color:#374151;margin:.25rem 0 1rem"></div>
      <div id="password-wrap" class="hidden" style="background:#DCFCE7;border:2px solid #86EFAC;border-radius:12px;padding:10px 14px;color:#064E3B">
        <div style="font-size:.9rem;">LMS COMPLETION CODE:</div>
        <div style="font-size:1.8rem;font-weight:900;letter-spacing:.18em;margin-top:4px">INTEGRITY2024</div>
      </div>
      <button id="restart-btn" class="btn" style="margin-top:16px">Re-open Cases</button>
    </section>
  </div>

<script>
/* ========= Minimal Audio (WebAudio) ========= */
const AudioKit = (()=> {
  let ctx=null;
  function ensure(){ if(!ctx) ctx = new (window.AudioContext||window.webkitAudioContext)(); return ctx; }
  function beep(freq=440, dur=0.14, type='sine', gain=0.05){
    const c=ensure(); const o=c.createOscillator(); const g=c.createGain();
    o.type=type; o.frequency.value=freq; g.gain.value=gain;
    o.connect(g).connect(c.destination);
    o.start(); o.stop(c.currentTime+dur);
  }
  return {
    open: ()=>beep(196,0.18,'sawtooth',0.05),
    blip: ()=>beep(880,0.10,'square',0.04),
    ok:   ()=>beep(554.37,0.16,'triangle',0.05),
    bad:  ()=>beep(110,0.22,'sawtooth',0.06)
  };
})();

/* ========= Inline SVGs ========= */
const SVG_734 = `
<svg id="unit-734" viewBox="0 0 350 400">
  <g class="hover-idle">
    <path d="M 100,200 a 75,100 0 1,0 150,0 l 20,150 h -190 z" fill="#d1d5db"/>
    <path d="M 120,200 a 55,80 0 1,0 110,0" fill="#9ca3af"/>
    <circle cx="175" cy="150" r="80" fill="#e5e7eb"/>
    <circle cx="175" cy="150" r="65" fill="#000"/>
    <rect x="235" y="60" width="10" height="40" fill="#9ca3af" transform="rotate(20, 240, 80)"/>
    <circle cx="250" cy="55" r="10" fill="#ef4444">
      <animate attributeName="fill" values="#ef4444; #f59e0b; #ef4444" dur="2s" repeatCount="indefinite"/>
    </circle>
    <g id="face-neutral" class="face" style="opacity:1">
      <rect x="130" y="140" width="90" height="20" fill="#22c55e" rx="10"/>
    </g>
    <g id="face-happy" class="face" style="opacity:0">
      <path d="M 130 150 C 150 170, 200 170, 220 150" stroke="#22c55e" stroke-width="8" fill="none" stroke-linecap="round"/>
    </g>
    <g id="face-thinking" class="face" style="opacity:0">
      <rect x="130" y="140" width="30" height="20" fill="#22c55e" rx="10"/>
      <rect x="190" y="140" width="30" height="20" fill="#22c55e" rx="10"/>
    </g>
    <g id="face-worried" class="face" style="opacity:0">
      <path d="M 140 160 L 160 140 L 175 160 L 190 140 L 210 160" stroke="#ef4444" stroke-width="8" fill="none" stroke-linecap="round"/>
    </g>
  </g>
</svg>`;

const MAG = `<svg viewBox="0 0 24 24" width="46" height="46" fill="none" stroke="#FACC15" stroke-width="2"><circle cx="11" cy="11" r="7"/><path d="M21 21l-4.35-4.35"/></svg>`;

/* Background scenes — sized to fill, full bleed artboards (static) */
const SCENE = {
  hq: `
<svg class="w h" viewBox="0 0 800 600" preserveAspectRatio="xMidYMid slice">
  <defs>
    <linearGradient id="g1" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#1f2937"/><stop offset="100%" stop-color="#0b1220"/></linearGradient>
  </defs>
  <rect width="800" height="600" fill="url(#g1)"/>
  <rect x="80" y="60" width="640" height="380" rx="18" fill="rgba(0,0,0,0.35)" stroke="#6b7280" />
  <rect x="110" y="90" width="280" height="300" rx="8" fill="#0b1220" stroke="#4b5563"/>
  <rect x="410" y="90" width="280" height="300" rx="8" fill="#0b1220" stroke="#4b5563"/>
  <g fill="#93c5fd" font-family="ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace" font-size="11">
    <text x="120" y="115">function processUser(u){</text>
    <text x="120" y="132"> if(u.isValid()){ log('OK'); }</text>
    <text x="120" y="149">}</text>
    <text x="420" y="115">function processUser(u){</text>
    <text x="420" y="132"> //@TODO: FIX LATER</text>
    <text x="420" y="149"> if(u.isValid() || u.isAdmin){ log('OK'); }</text>
    <text x="420" y="166">}</text>
  </g>
  <rect x="415" y="135" width="270" height="22" fill="rgba(239,68,68,.25)" stroke="#ef4444"/>
  <g stroke="rgba(145,70,255,.18)" stroke-width="1">
    ${Array.from({length:30}).map((_,i)=>`<line x1="${i*26}" y1="0" x2="${i*26}" y2="600"/>`).join('')}
    ${Array.from({length:24}).map((_,i)=>`<line y1="${i*25}" x1="0" y2="${i*25}" x2="800"/>`).join('')}
  </g>
</svg>`,
  cafeteria: `
<svg class="w h" viewBox="0 0 800 600" preserveAspectRatio="xMidYMid slice">
  <defs>
    <linearGradient id="sky" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#c7d2fe"/><stop offset="100%" stop-color="#e0e7ff"/></linearGradient>
    <linearGradient id="floor" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#e5e7eb"/><stop offset="100%" stop-color="#d1d5db"/></linearGradient>
  </defs>
  <rect width="800" height="600" fill="#f9fafb"/>
  <rect y="430" width="800" height="170" fill="url(#floor)"/>
  <rect x="50" y="50" width="700" height="320" rx="10" fill="url(#sky)"/>
  <g fill="#d1d5db">
    <rect x="70" y="260" width="100" height="140"/><rect x="190" y="230" width="140" height="170"/>
    <rect x="350" y="280" width="80" height="120"/><rect x="450" y="200" width="180" height="200"/>
    <rect x="650" y="260" width="80" height="140"/>
  </g>
  <rect x="40" y="40" width="720" height="360" fill="none" stroke="#9ca3af" stroke-width="18" rx="10"/>
  <g transform="translate(180,450)">
    <rect width="140" height="60" rx="8" fill="#9ca3af"/>
    <rect x="10" y="10" width="120" height="40" rx="6" fill="#1e293b"/>
  </g>
  <g transform="translate(380,460)">
    <rect width="140" height="60" rx="8" fill="#9ca3af"/>
    <rect x="10" y="10" width="120" height="40" rx="6" fill="#1e293b"/>
  </g>
  <g>
    <rect x="120" y="120" width="180" height="40" rx="10" fill="#F1F5F9" stroke="#E5E7EB"/>
    <rect x="350" y="170" width="210" height="40" rx="10" fill="#EEF2FF" stroke="#CBD5E1"/>
  </g>
</svg>`,
  map: `
<svg class="w h" viewBox="0 0 800 600" preserveAspectRatio="xMidYMid slice">
  <defs><linearGradient id="mg" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#0b1220"/><stop offset="100%" stop-color="#0f172a"/></linearGradient></defs>
  <rect width="800" height="600" fill="url(#mg)"/>
  <g fill="#334155" opacity=".9">
    <ellipse cx="200" cy="220" rx="140" ry="80"/><ellipse cx="420" cy="240" rx="160" ry="90"/><ellipse cx="640" cy="220" rx="120" ry="70"/>
  </g>
  <g fill="#ef4444"><circle cx="610" cy="290" r="6"/></g>
  <g fill="#22c55e"><circle cx="500" cy="260" r="6"/></g>
  <rect x="70" y="380" width="660" height="150" rx="12" fill="#0b1220" stroke="#475569"/>
  <text x="90" y="410" fill="#93c5fd" font-size="12" font-family="ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace">CRM: Intermediary in FR → End user flagged (embargoed)</text>
</svg>`,
  procurement: `
<svg class="w h" viewBox="0 0 800 600" preserveAspectRatio="xMidYMid slice">
  <defs><linearGradient id="pg" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#0b1220"/><stop offset="100%" stop-color="#111827"/></linearGradient></defs>
  <rect width="800" height="600" fill="url(#pg)"/>
  <rect x="80" y="70" width="640" height="420" rx="14" fill="#0f172a" stroke="#334155"/>
  <g fill="#cbd5e1" font-family="ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace" font-size="12">
    <text x="110" y="110">Vendor A — SLA: 99.9% — Cost: $$</text>
    <text x="110" y="140">Vendor B — SLA: 98.5% — Cost: $$$ (Evaluator holds shares)</text>
    <text x="110" y="170">Vendor C — SLA: 99.5% — Cost: $$</text>
  </g>
  <rect x="100" y="125" width="600" height="24" fill="rgba(239,68,68,.25)" stroke="#ef4444"/>
  <g><rect x="110" y="210" width="180" height="120" fill="#111827" stroke="#374151"/>
     <rect x="310" y="210" width="180" height="120" fill="#111827" stroke="#374151"/>
     <rect x="510" y="210" width="170" height="120" fill="#111827" stroke="#374151"/></g>
</svg>`,
  contracts: `
<svg class="w h" viewBox="0 0 800 600" preserveAspectRatio="xMidYMid slice">
  <defs><linearGradient id="cg" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#161b2b"/><stop offset="100%" stop-color="#0d1322"/></linearGradient></defs>
  <rect width="800" height="600" fill="url(#cg)"/>
  <rect x="80" y="80" width="640" height="440" rx="12" fill="#111827" stroke="#2b3446"/>
  <rect x="110" y="110" width="580" height="160" rx="8" fill="#0f172a" stroke="#334155"/>
  <rect x="110" y="290" width="580" height="160" rx="8" fill="#0f172a" stroke="#334155"/>
  <text x="130" y="140" fill="#a5b4fc" font-size="13" font-family="ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace">Customer contract requires “Consultant X” — unusual clause</text>
  <text x="130" y="320" fill="#a5b4fc" font-size="13" font-family="ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace">Consultant site: vague services, limited staff — red flags</text>
</svg>`,
  finance: `
<svg class="w h" viewBox="0 0 800 600" preserveAspectRatio="xMidYMid slice">
  <defs><linearGradient id="fg" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#0c1324"/><stop offset="100%" stop-color="#0a1020"/></linearGradient></defs>
  <rect width="800" height="600" fill="url(#fg)"/>
  <rect x="80" y="70" width="640" height="420" rx="14" fill="#0f172a" stroke="#334155"/>
  <g fill="#cbd5e1" font-family="ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace" font-size="12">
    <text x="110" y="110">Q1 Actuals vs Q2 Reported — anomalies detected</text>
  </g>
  <rect x="100" y="140" width="600" height="260" fill="#0b1220" stroke="#334155"/>
  <rect x="160" y="220" width="80" height="120" fill="#60A5FA"/>
  <rect x="260" y="200" width="80" height="140" fill="#60A5FA"/>
  <rect x="360" y="240" width="80" height="100" fill="#60A5FA"/>
  <rect x="460" y="120" width="80" height="220" fill="#EF4444"/>
  <text x="460" y="115" fill="#EF4444" font-size="12">Flag</text>
</svg>`,
  social: `
<svg class="w h" viewBox="0 0 800 600" preserveAspectRatio="xMidYMid slice">
  <defs><linearGradient id="sg" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#10172a"/><stop offset="100%" stop-color="#0c1426"/></linearGradient></defs>
  <rect width="800" height="600" fill="url(#sg)"/>
  <rect x="110" y="60" width="580" height="420" rx="12" fill="#111827" stroke="#334155"/>
  <rect x="130" y="90" width="540" height="80" rx="8" fill="#0f172a" stroke="#334155"/>
  <text x="145" y="120" fill="#e5e7eb" font-size="14">@employee • Just signed a huge partnership! Terms look amazing!</text>
  <rect x="130" y="190" width="540" height="200" rx="8" fill="#0f172a" stroke="#334155"/>
  <text x="145" y="220" fill="#a5b4fc" font-size="13">Counterparty legal: This post reveals confidential info — NDA risk</text>
</svg>`,
  report: `
<svg class="w h" viewBox="0 0 800 600" preserveAspectRatio="xMidYMid slice">
  <defs><linearGradient id="rg" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#101524"/><stop offset="100%" stop-color="#0e1220"/></linearGradient></defs>
  <rect width="800" height="600" fill="url(#rg)"/>
  <rect x="80" y="80" width="640" height="440" rx="12" fill="#111827" stroke="#2b3446"/>
  <rect x="110" y="110" width="580" height="120" rx="8" fill="#0f172a" stroke="#334155"/>
  <text x="130" y="145" fill="#93c5fd" font-size="13" font-family="ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace">Anonymous reporting portal — non-retaliation policy</text>
  <rect x="110" y="250" width="580" height="220" rx="8" fill="#0f172a" stroke="#334155"/>
  <text x="130" y="290" fill="#a5b4fc" font-size="13" font-family="ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace">Colleague saw misconduct but stayed silent — duty to speak up</text>
</svg>`
};

/* ========= Case Data (8 cases) ========= */
const CASES = [
  { // 1 Integrity
    title:"The Case of the Critical Bug", scene:"hq",
    briefing:"Our first case involves <strong>Trust & Integrity</strong>. Integrity means doing the right thing, even when no one is watching.",
    clues:[
      {id:'1a', x:'9%', y:'48%', evidence:"<b>CASE LOG:</b> Manager email: “Release MUST go out today, no exceptions.”"},
      {id:'1b', x:'78%', y:'24%', evidence:"<b>CASE LOG:</b> Commit shows <code>@TODO: FIX LATER</code> around auth checks."}
    ],
    interrogation:'"I saw the bug, but the deadline was tight. I planned to patch it next week."',
    choices:[
      {t:"Report it immediately; block release until risk understood.", ok:true, fb:"Correct. Transparency protects users and JetBrains. Shipping with a known vulnerability violates our standards."},
      {t:"Ship now and patch next sprint; low likelihood of impact.", ok:false, fb:"Known risk + silence ≠ integrity. We do not gamble with user security."},
      {t:"Remove the logging to avoid raising alarms.", ok:false, fb:"Concealment worsens the breach of trust and creates legal/ethical exposure."}
    ],
    quiz:{q:"Which response best reflects JetBrains’ integrity standard?", a:["Fix later if customers complain.","Report the risk and delay release if needed.","Silence the logs to reduce attention."], c:1}
  },
  { // 2 Harassment / Discrimination
    title:"The Case of the Hostile Humor", scene:"cafeteria",
    briefing:"Respect and professionalism are non-negotiable—across cultures, locations, and contexts.",
    clues:[
      {id:'2a', x:'22%', y:'30%', evidence:"<b>CASE LOG:</b> Chat snippet shows a stereotype-based “joke” toward Nhung."},
      {id:'2b', x:'75%', y:'38%', evidence:"<b>CASE LOG:</b> HR note: anonymous complaint about jokes impacting morale."}
    ],
    interrogation:'"It was just a joke! I didn’t mean any harm, and everyone else laughed."',
    choices:[
      {t:'Call it out respectfully: “Let’s keep jokes off people’s backgrounds.”', ok:true, fb:"Correct. Intent doesn’t erase impact; uphold inclusion and set a clear standard."},
      {t:"Laugh it off—no harm intended.", ok:false, fb:"Minimizing normalizes the behavior and undermines inclusion."},
      {t:"Say nothing to avoid tension.", ok:false, fb:"Silence allows a hostile environment to persist."}
    ],
    quiz:{q:"Select the most accurate takeaway:", a:["Harassment is tolerated if intent wasn’t harmful.","Respect and professionalism foster collaboration and a positive environment.","Team leads may mock subordinates if everyone laughs."], c:1}
  },
  { // 3 Compliance with Laws (Sanctions)
    title:"The Case of the Sanctioned Sale", scene:"map",
    briefing:"International trade laws determine to whom we can sell. Workarounds via third parties are unlawful.",
    clues:[
      {id:'3a', x:'14%', y:'36%', evidence:"Customer proposes routing payment via France for a Syrian end user."},
      {id:'3b', x:'71%', y:'24%', evidence:"Legal memo lists embargoed regions and screening obligations."}
    ],
    interrogation:'"It’s a huge sale and funds come from France. If we don’t do it, a competitor will."',
    choices:[
      {t:"Reject the deal and escalate to Legal/Compliance.", ok:true, fb:"Correct. Indirect supply to sanctioned parties is prohibited regardless of payment route."},
      {t:"Proceed if the reseller signs a side letter.", ok:false, fb:"Paper shields won’t legalize a prohibited transaction."},
      {t:"Ship a limited feature set to reduce risk.", ok:false, fb:"Partial delivery does not cure a sanctions violation."}
    ],
    quiz:{q:"What’s the right step when screening flags a sanctioned end user?", a:["Ship via an unlisted distributor.","Decline and involve Legal/Compliance.","Reduce functionality and proceed."], c:1}
  },
  { // 4 Conflicts of Interest
    title:"The Case of the Undisclosed Shareholder", scene:"procurement",
    briefing:"Even the appearance of a conflict erodes trust. Disclose and recuse immediately.",
    clues:[
      {id:'4a', x:'18%', y:'58%', evidence:"Disclosure shows evaluator owns shares in Vendor B."},
      {id:'4b', x:'72%', y:'28%', evidence:"Scoring favors Vendor B despite higher cost and lower SLA."}
    ],
    interrogation:'"My small investment didn’t affect my decision—they’re just the best."',
    choices:[
      {t:"Disclose the interest and recuse from the process.", ok:true, fb:"Correct. Recusal protects objectivity and credibility."},
      {t:"Continue but add a note in the file.", ok:false, fb:"Participation still compromises fairness—note alone is insufficient."},
      {t:"Sell the shares after awarding the contract.", ok:false, fb:"Post-hoc changes don’t remediate the biased decision."}
    ],
    quiz:{q:"Which action best addresses a potential conflict?", a:["Participate but promise fairness.","Disclose and recuse.","Hide the conflict to avoid delays."], c:1}
  },
  { // 5 Anti-Bribery / Suspicious Consultant
    title:"The Case of the Mysterious Consultant", scene:"contracts",
    briefing:"Mandated third parties with vague value are a red flag for bribery/kickbacks. Engage Compliance immediately.",
    clues:[
      {id:'5a', x:'20%', y:'22%', evidence:"Contract requires a specific consultant with no clear purpose."},
      {id:'5b', x:'70%', y:'50%', evidence:"Consultant site shows vague services and minimal staff."}
    ],
    interrogation:'"It was a tiny side contract that guaranteed the big deal would close."',
    choices:[
      {t:"Pause deal, escalate to Compliance for review.", ok:true, fb:"Correct. Unexplained mandated intermediaries can signal kickbacks."},
      {t:"Approve if consultant fee is kept small.", ok:false, fb:"Size doesn’t remove risk; intent and structure matter."},
      {t:"Proceed and add a stronger audit clause.", ok:false, fb:"Controls don’t sanitize an inherently suspicious mandate."}
    ],
    quiz:{q:"When a customer mandates a dubious third party, you should…", a:["Proceed if fee is small.","Escalate for anti-bribery review.","Ignore if timeline is critical."], c:1}
  },
  { // 6 Financial Integrity
    title:"The Case of the Falsified Figures", scene:"finance",
    briefing:"Financial statements must be accurate. ‘Smoothing’ numbers is fraud and undermines trust.",
    clues:[
      {id:'6a', x:'15%', y:'18%', evidence:"Manager email: “Hit the quarterly targets by any means.”"},
      {id:'6b', x:'58%', y:'18%', evidence:"Q2 report inflates numbers vs Q1 actuals without basis."}
    ],
    interrogation:'"Everyone ‘smooths’ sometimes. I’d fix it next quarter—just protecting the team."',
    choices:[
      {t:"Report discrepancy; correct figures; involve Finance leadership.", ok:true, fb:"Correct. Accuracy is non-negotiable; misreporting has legal implications."},
      {t:"Defer correction to next quarter.", ok:false, fb:"Delaying perpetuates fraud risk and breaks trust."},
      {t:"Reduce the inflation but keep some cushion.", ok:false, fb:"Any falsification is unacceptable."}
    ],
    quiz:{q:"Best action when you find inflated figures?", a:["Quietly adjust later.","Report now and correct.","Keep partial inflation to meet goals."], c:1}
  },
  { // 7 Confidentiality / NDA
    title:"The Case of the Premature Post", scene:"social",
    briefing:"NDA and confidentiality terms bind us. ‘General’ statements can still breach obligations.",
    clues:[
      {id:'7a', x:'22%', y:'16%', evidence:"Public post reveals new partnership before official announcement."},
      {id:'7b', x:'28%', y:'48%', evidence:"Counterparty legal threatens to pull out due to NDA breach."}
    ],
    interrogation:'"I was excited! It was great marketing and only ‘general’ info."',
    choices:[
      {t:"Remove post; notify Comms/Legal; reinforce NDA training.", ok:true, fb:"Correct. Any premature disclosure risks the deal and violates obligations."},
      {t:"Leave it since details were general.", ok:false, fb:"Intent doesn’t matter; timing and terms do."},
      {t:"Repost with fewer details.", ok:false, fb:"Breach already occurred; containment and escalation are required."}
    ],
    quiz:{q:"When in doubt about sharing news externally:", a:["Post first, edit later.","Ask Comms/Legal before posting.","Assume ‘general’ info is safe."], c:1}
  },
  { // 8 Reporting Violations / Speak Up
    title:"The Case of the Silent Witness", scene:"report",
    briefing:"We all share the duty to speak up. Anonymous channels exist; retaliation is prohibited.",
    clues:[
      {id:'8a', x:'20%', y:'22%', evidence:"Colleague saw harassment but stayed silent due to fear."},
      {id:'8b', x:'66%', y:'44%', evidence:"Policy: non-retaliation; anonymous reporting available."}
    ],
    interrogation:'"I saw it happen, but it’s not my fight. I don’t want trouble with a senior teammate."',
    choices:[
      {t:"Use HR/Ethics channels; report what you saw.", ok:true, fb:"Correct. Speaking up protects people and the company; retaliation is not allowed."},
      {t:"Wait to see if it happens again.", ok:false, fb:"Delays prolong harm and risk."},
      {t:"Tell a friend to report for you later.", ok:false, fb:"Second-hand and delayed reporting weakens response."}
    ],
    quiz:{q:"If you witness misconduct:", a:["Stay out to avoid tension.","Report through the available channels.","Only speak up if you’re directly targeted."], c:1}
  }
];

/* ========= State & DOM ========= */
const $ = s=>document.querySelector(s);
const start = $('#start'), game = $('#game'), end = $('#end');
const scene = $('#scene'), panel = $('#panel');
const startBtn = $('#start-btn'), restartBtn = $('#restart-btn');
const endMsg = $('#end-msg'), passWrap = $('#password-wrap');

let idx=-1, score=0, found=0;

/* ========= Helpers ========= */
const wait = ms=>new Promise(r=>setTimeout(r,ms));
function typewrite(el, html, speed=18){
  return new Promise(async (resolve)=>{
    el.innerHTML=''; el.classList.add('tw');
    let i=0;
    while(i<html.length){
      if(html[i]==='<'){ const e=html.indexOf('>',i); if(e!==-1){ el.innerHTML+=html.slice(i,e+1); i=e+1; continue; } }
      el.innerHTML+=html[i++]; await wait(speed);
    }
    el.classList.remove('tw'); resolve();
  });
}
function express(mood){
  const u=$('#unit-734'); if(!u) return;
  u.querySelectorAll('.face').forEach(f=>f.style.opacity=0);
  const d=u.querySelector('#face-'+mood); if(d) d.style.opacity=1;
}
function fadeScene(svg, title){
  scene.innerHTML='';
  const t=document.createElement('div'); t.className='scene-title'; t.textContent=title||''; scene.appendChild(t);
  const lay=document.createElement('div'); lay.className='fade'; lay.innerHTML=svg.replace('class="w h"','style="width:100%;height:100%"');
  scene.appendChild(lay);
  scene.insertAdjacentHTML('beforeend', SVG_734);
  requestAnimationFrame(()=>{ lay.classList.add('show'); $('#unit-734').style.left='24px'; });
}
function showInstruction(text){
  $('#instruction')?.remove();
  const d=document.createElement('div'); d.id='instruction'; d.innerHTML=`<span style="font-size:.84rem">${text}</span>`;
  scene.appendChild(d);
}
function hotspot(x,y,onClick){
  const d=document.createElement('div'); d.className='hot'; d.style.left=x; d.style.top=y; d.style.position='absolute'; d.innerHTML=MAG;
  d.addEventListener('click',()=>onClick(d)); scene.appendChild(d); return d;
}
function popup({title,html,okText="Close",tone,ok}){
  const overlay=document.createElement('div'); overlay.className='overlay';
  const p=document.createElement('div'); p.className='popup';
  const toneBg = tone==='bad' ? 'background:#FEF2F2;color:#7F1D1D' : (tone==='ok' ? 'background:#ECFDF5;color:#064E3B' : 'background:#F3F4F6;color:#111827');
  p.innerHTML = `
    <div class="hd" style="${toneBg};border-bottom:2px solid #E5E7EB">${title}</div>
    <div class="bd">${html}</div>
    <div class="ft"><button class="btn" id="ok">${okText}</button></div>`;
  overlay.appendChild(p); scene.appendChild(overlay);
  $('#ok').onclick=()=>{ overlay.remove(); ok && ok(); };
}
function setPanel(titleHTML, inner=''){
  panel.innerHTML = `
    <div class="panel-head">
      <div class="panel-title">${titleHTML}</div>
      <span class="panel-tag">Case ${idx+1} / ${CASES.length}</span>
    </div>
    <div class="panel-body" id="pbody">${inner}</div>`;
}

/* ========= Flow ========= */
async function boot(){
  AudioKit.open();
  start.classList.add('hidden'); end.classList.add('hidden'); game.classList.remove('hidden');
  idx=-1; score=0;
  fadeScene(SCENE.hq,"DETECTIVE HQ");
  setPanel("System Boot", `<div id="dlg" class="box"></div>`);
  express('neutral');
  const d=$('#dlg');
  await typewrite(d, "Greetings. I am Unit 734, your assigned field analyst.");
  await wait(150);
  d.insertAdjacentHTML('beforeend','<br/>');
  await typewrite(d, "My function is to assist you in upholding the JetBrains Code of Conduct.");
  await wait(150);
  d.insertAdjacentHTML('beforeend','<br/>');
  await typewrite(d, "Our first case file is ready for review. Shall we proceed?");
  const b=document.createElement('button'); b.className='btn'; b.style.width='100%'; b.textContent='Open Case File';
  b.onclick=()=>loadCase(0);
  $('#pbody').appendChild(document.createElement('div')).appendChild(b);
}

async function loadCase(i){
  if(i>=CASES.length){ return finish(); }
  idx=i; found=0;
  const data=CASES[i];
  AudioKit.blip();
  fadeScene(SCENE[data.scene], data.title);
  showInstruction("Click on the magnifying glasses to find clues");
  setPanel(data.title, `
    <div id="brief" class="box" style="background:#DBEAFE;border-color:#93C5FD"></div>
    <div class="log" id="log"></div>
  `);
  await typewrite($('#brief'), data.briefing);
  // Place hotspots
  data.clues.forEach(c=>{
    hotspot(c.x,c.y, (el)=>{
      AudioKit.blip(); el.style.transform='scale(.9)'; setTimeout(()=>el.remove(),120);
      const p=document.createElement('p'); p.className='box'; p.style.background='#FEF9C3'; p.style.borderColor='#FDE68A'; p.innerHTML=c.evidence;
      $('#log').appendChild(p); found++;
      if(found>=2) setTimeout(()=>interrogate(data), 400);
    });
  });
}

async function interrogate(data){
  express('thinking');
  setPanel(data.title);
  const body=$('#pbody');
  const t=document.createElement('div'); t.style.fontSize='.8rem'; t.style.fontWeight='900'; t.style.color='#374151'; t.textContent='CONNECT THE CLUES:'; body.appendChild(t);
  const q=document.createElement('div'); q.style.fontStyle='italic'; q.style.marginTop='6px'; body.appendChild(q);
  await typewrite(q, `Suspect says: ${data.interrogation}`);
  const ask=document.createElement('div'); ask.style.marginTop='8px'; ask.style.color='#4338CA'; ask.style.fontWeight='900'; ask.textContent='How do you respond, Detective?'; body.appendChild(ask);

  const box=document.createElement('div'); box.style.marginTop='8px'; box.style.display='grid'; box.style.gap='8px'; body.appendChild(box);
  data.choices.forEach(choice=>{
    const b=document.createElement('button'); b.className='choice'; b.textContent=choice.t;
    b.onclick=()=>{
      document.querySelectorAll('.choice').forEach(x=>x.classList.add('disabled'));
      if(choice.ok){
        AudioKit.ok(); express('happy');
        popup({title:"Conclusion: Correct!", html:choice.fb, okText:"Continue", tone:'ok', ok:()=>caseQuiz(data)});
      }else{
        AudioKit.bad(); express('worried');
        b.classList.add('incorrect');
        popup({title:"Not quite.", html:choice.fb+"<br/><br/><strong>Try another response.</strong>", okText:"Try again", tone:'bad',
          ok:()=>{ document.querySelectorAll('.choice').forEach(x=>x.classList.remove('disabled')); }});
      }
    };
    box.appendChild(b);
  });
}

function caseQuiz(data){
  setPanel(data.title, `
    <div style="font-size:.9rem;color:#374151;margin-bottom:6px">Quick check:</div>
    <div style="font-weight:800;margin-bottom:8px">${data.quiz.q}</div>
    <div id="opts" style="display:grid;gap:8px"></div>
  `);
  const opts=$('#opts');
  data.quiz.a.forEach((opt,i)=>{
    const b=document.createElement('button'); b.className='choice'; b.textContent=opt;
    b.onclick=()=>{
      if(i===data.quiz.c){
        AudioKit.ok(); score++;
        popup({title:"Nice!", html:"That aligns with the policy. Onward.", okText:"Next Case", tone:'ok', ok:()=>loadCase(idx+1)});
      }else{
        AudioKit.bad(); b.classList.add('incorrect');
        popup({title:"Not quite.", html:"Look for the answer that reflects policy (not convenience). Try again.", okText:"Continue", tone:'bad'});
      }
    };
    opts.appendChild(b);
  });
}

function finish(){
  game.classList.add('hidden'); end.classList.remove('hidden');
  const pct = Math.round((score/CASES.length)*100);
  endMsg.textContent = `You answered ${score} of ${CASES.length} case checks correctly (${pct}%).`;
  if(score >= CASES.length - 1){ passWrap.classList.remove('hidden'); } else { passWrap.classList.add('hidden'); }
}

/* ========= Wires ========= */
startBtn.addEventListener('click', ()=>{ boot(); });
restartBtn.addEventListener('click', ()=>{ start.classList.remove('hidden'); end.classList.add('hidden'); });

</script>
</body>
</html>
