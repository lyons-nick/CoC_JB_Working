<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Detectives: The JetBrains Case Files</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Special+Agent&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        @font-face {
            font-family: 'Special Agent';
            src: url('https://fonts.cdnfonts.com/s/52003/SpecialAgent-RpvEa.woff') format('woff');
        }
        body {
            font-family: 'Roboto Mono', monospace;
            background-color: #4b5563; /* Slate 600 */
            overflow: hidden;
        }
        .case-file-container {
            background-image: url('https://www.transparenttextures.com/patterns/lined-paper.png'), linear-gradient(to bottom right, #fdfbfb, #ebedee);
            background-color: #f3f4f6; /* Gray 100 */
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4), inset 0 0 10px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 1000px;
            aspect-ratio: 16 / 10;
            max-height: 95vh;
            overflow: hidden;
            border: 10px solid #d1d5db; /* Gray 300 */
        }
        .hidden { display: none !important; }

        /* Animations */
        @keyframes clue-pop {
            0% { transform: scale(0.5); opacity: 0; }
            70% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }
        @keyframes clue-fade-out { to { opacity: 0; transform: scale(0.5); } }
        @keyframes hover-float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        @keyframes code-scroll {
            from { transform: translateY(0); }
            to { transform: translateY(-100px); }
        }
        @keyframes fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .clue-hotspot {
            position: absolute;
            cursor: pointer;
            animation: clue-pop 0.5s ease-out forwards;
            transition: opacity 0.3s, transform 0.3s;
        }
        .clue-hotspot:hover .magnifying-glass { transform: scale(1.2) rotate(10deg); }
        .clue-hotspot.found { animation: clue-fade-out 0.3s ease-out forwards; }

        /* Character Styles */
        #unit-734 {
            position: absolute;
            bottom: -20px;
            transition: all 0.8s cubic-bezier(0.25, 1, 0.5, 1);
            width: 280px;  
            height: 320px; 
        }
        #unit-734 .hover-idle { animation: hover-float 4s ease-in-out infinite; }
        .face, .arm { transition: opacity 0.2s ease-in-out, transform 0.3s ease-out; }

        /* UI Elements */
        #scene { position: relative; }
        #case-details {
            background: rgba(255,255,255,0.85);
            backdrop-filter: blur(5px);
            border-left: 5px solid #4f46e5;
        }
        .choice-btn {
            background: #fff;
            border: 2px solid #6b7280;
            transition: all 0.2s ease;
        }
        .choice-btn:hover:not(.disabled) {
            background: #e0e7ff;
            border-color: #4f46e5;
        }
        .choice-btn.disabled { cursor: not-allowed; opacity: 0.5; }
        .choice-btn.incorrect-choice {
            background-color: #fee2e2;
            border-color: #fca5a5;
            text-decoration: line-through;
        }
        
        #instruction-panel {
            animation: clue-pop 0.5s 1s ease-out forwards;
            opacity: 0;
            position: absolute;  
            bottom: 1rem;  
            right: 1rem;   
            transform: none;
        }
        
        .typewriter-cursor::after {
            content: '|';
            animation: blink 1s step-end infinite;
        }
        @keyframes blink { 50% { opacity: 0; } }

        .popup-anim {
            animation: clue-pop 0.3s ease-out forwards;
        }
        .popup-anim strong {
            font-weight: 700;
            color: #111827;
        }
        
    </style>
</head>
<body>

    <div class="case-file-container flex flex-col">
        <div id="start-screen" class="flex-1 flex flex-col items-center justify-center p-8 text-center bg-gray-200">
            <h1 class="text-6xl font-bold text-gray-800 mb-2" style="font-family: 'Special Agent', sans-serif;">Code Detectives</h1>
            <p class="text-xl text-gray-600 mb-8">The JetBrains Case Files</p>
            <button id="start-btn" class="bg-indigo-600 text-white font-bold py-3 px-12 rounded-lg text-2xl hover:bg-indigo-700 transition-all transform hover:scale-105">Open the First Case</button>
        </div>

        <div id="game-screen" class="hidden flex-1 grid grid-cols-3 h-full">
            <div id="scene" class="col-span-2 overflow-hidden"></div>
            <div id="case-details" class="col-span-1 p-4 flex flex-col overflow-y-auto min-h-0"></div>
        </div>
        
        <div id="end-screen" class="hidden flex-1 flex flex-col items-center justify-center p-8 text-center bg-gray-200">
             <h1 class="text-5xl font-bold text-gray-800 mb-4" style="font-family: 'Special Agent', sans-serif;">All Cases Closed</h1>
             <div id="end-message" class="text-2xl mb-6 text-gray-700"></div>
             <div id="password-container" class="hidden mt-4 p-4 bg-green-100 border-2 border-green-400 rounded-lg w-full max-w-md">
                 <p class="text-md text-green-800">LMS COMPLETION CODE:</p>
                 <p class="text-3xl mt-1 font-bold tracking-widest text-green-900">INTEGRITY2024</p>
             </div>
             <p id="lms-instructions" class="mt-4 text-md text-gray-600 max-w-sm hidden">To receive a passing grade, please copy the code above and enter it into the LMS.</p>
             <button id="restart-btn" class="mt-8 bg-indigo-600 text-white font-bold py-3 px-12 rounded-lg text-xl hover:bg-indigo-700">Re-open Cases</button>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- DOM Elements ---
    const startScreen = document.getElementById('start-screen');
    const gameScreen = document.getElementById('game-screen');
    const endScreen = document.getElementById('end-screen');
    const startBtn = document.getElementById('start-btn');
    const restartBtn = document.getElementById('restart-btn');
    const scene = document.getElementById('scene');
    const caseDetails = document.getElementById('case-details');
    const lmsInstructions = document.getElementById('lms-instructions');


    // --- SVG Templates ---
    const SVG_UNIT734 = `
        <svg id="unit-734" viewBox="0 0 350 400">
            <g class="hover-idle">
                <path d="M 100,200 a 75,100 0 1,0 150,0 l 20,150 h -190 z" fill="#d1d5db"/>
                <path d="M 120,200 a 55,80 0 1,0 110,0" fill="#9ca3af"/>
                <circle cx="175" cy="150" r="80" fill="#e5e7eb"/>
                <circle cx="175" cy="150" r="65" fill="#000"/>
                <rect x="235" y="60" width="10" height="40" fill="#9ca3af" transform="rotate(20, 240, 80)"/>
                <circle cx="250" cy="55" r="10" fill="#ef4444"><animate attributeName="fill" values="#ef4444; #f59e0b; #ef4444" dur="2s" repeatCount="indefinite" /></circle>
                <g id="face-neutral" class="face" style="opacity:1;">
                    <rect x="130" y="140" width="90" height="20" fill="#22c55e" rx="10"/>
                </g>
                <g id="face-happy" class="face" style="opacity:0;">
                    <path d="M 130 150 C 150 170, 200 170, 220 150" stroke="#22c55e" stroke-width="8" fill="none" stroke-linecap="round"/>
                </g>
                <g id="face-thinking" class="face" style="opacity:0;">
                    <rect x="130" y="140" width="30" height="20" fill="#22c55e" rx="10"/>
                    <rect x="190" y="140" width="30" height="20" fill="#22c55e" rx="10"/>
                </g>
                 <g id="face-worried" class="face" style="opacity:0;">
                     <path d="M 140 160 L 160 140 L 175 160 L 190 140 L 210 160" stroke="#ef4444" stroke-width="8" fill="none" stroke-linecap="round"/>
                </g>
            </g>
        </svg>`;
    const SVG_MAGNIFYING_GLASS = `<svg class="magnifying-glass w-16 h-16 text-yellow-400 transition-transform"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>`;

    // --- Scene SVG Data ---
    const SCENE_SVGS = {
        hq: `<svg width="100%" height="100%" viewBox="0 0 800 600" preserveAspectRatio="xMidYMid slice">
            <defs>
                <radialGradient id="grad1" cx="50%" cy="50%" r="50%" fx="50%" fy="50%"><stop offset="0%" stop-color="#4338ca"/><stop offset="100%" stop-color="#1e1b4b"/></radialGradient>
                 <pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse"><path d="M 20 0 L 0 0 0 20" fill="none" stroke="rgba(129, 140, 248, 0.2)" stroke-width="1"/></pattern>
            </defs>
            <rect width="100%" height="100%" fill="url(#grad1)"/><rect width="100%" height="100%" fill="url(#grid)"/>
            <rect x="100" y="50" width="600" height="400" fill="rgba(0,0,0,0.3)" rx="20" stroke="rgba(165, 180, 252, 0.5)" stroke-width="2"/>
            <text x="400" y="40" font-family="Roboto Mono, monospace" font-size="20" fill="#a5b4fc" text-anchor="middle">DETECTIVE HQ</text>
            <path d="M120 100 C 200 150, 300 100, 400 150 S 600 200, 700 150" stroke="#a5b4fc" stroke-width="2" fill="none" stroke-dasharray="10 20"><animate attributeName="stroke-dashoffset" from="30" to="0" dur="2s" repeatCount="indefinite"/></path>
            <path d="M120 300 C 250 250, 350 350, 500 300 S 650 250, 700 300" stroke="#a5b4fc" stroke-width="1" fill="none" stroke-dasharray="5 15"><animate attributeName="stroke-dashoffset" from="0" to="20" dur="3s" repeatCount="indefinite"/></path>
        </svg>`,
        codeReview: `<svg width="100%" height="100%" viewBox="0 0 800 600" preserveAspectRatio="xMidYMid slice">
            <rect width="100%" height="100%" fill="#020617"/>
            <rect x="50" y="50" width="330" height="500" fill="#1e293b" rx="10"/>
            <foreignObject x="60" y="60" width="310" height="480">
                <pre xmlns="http://www.w3.org/1999/xhtml" style="color: #94a3b8; font-size: 12px; white-space: pre-wrap;"><code>function processUser(user) {
  // ...
  if (user.isValid()) {
    console.log('Processing...');
    // A lot of important code here...
  }
}</code><animateTransform attributeName="transform" type="translate" from="0 0" to="0 -50" dur="8s" repeatCount="indefinite"/></pre>
            </foreignObject>
            <rect x="420" y="50" width="330" height="500" fill="#1e293b" rx="10"/>
             <foreignObject x="430" y="60" width="310" height="480">
                <pre xmlns="http://www.w3.org/1999/xhtml" style="color: #94a3b8; font-size: 12px; white-space: pre-wrap;"><code>function processUser(user) {
  // ...
  // @TODO: FIX LATER
  // BUG: Bypassing validation for admins
  if (user.isValid() || user.isAdmin) {
    console.log('Processing...');
    // ...
  }
}</code></pre>
            </foreignObject>
            <rect x="425" y="125" width="320" height="25" fill="#ef4444" fill-opacity="0.2" stroke="#ef4444" stroke-width="1"/>
        </svg>`
    };

    // --- Game Data ---
    const caseFiles = [
        { 
            title: "The Case of the Critical Bug", 
            briefing: "Our first case involves <strong>Trust and Integrity</strong>. Integrity means doing the right thing, even when no one is watching. Let's see what happens.", 
            sceneSVG: SCENE_SVGS.codeReview, 
            clues: [
                { id: 'clue1-1', type: 'email', x: '10%', y: '45%', evidence: "<b>CASE LOG:</b> Email from manager says 'Release MUST go out today, no exceptions!'" }, 
                { id: 'clue1-2', type: 'text', x: '80%', y: '20%', evidence: "<b>CASE LOG:</b> Code commit shows a vulnerability marked '@TODO: FIX LATER'." }
            ], 
            interrogation: "'Look, I saw the bug, but the deadline was tight. I figured I'd patch it next week. What was I supposed to do?'", 
            choices: [
                { text: "Your Response: 'You should have reported it immediately.'", correct: true, feedback: "By prioritizing transparency and security over a deadline, you protect our users and uphold the trust they place in JetBrains. This is the core of our <strong>Integrity</strong> principle." }, 
                { text: "Your Response: 'You were right to prioritize the deadline.'", correct: false, feedback: "The principle of <strong>Integrity</strong> means we must be transparent about errors, especially those that impact security. Hiding a problem puts our users and our company's reputation at risk." }
            ] 
        }
    ];

    // --- Game State & Animation ---
    let currentCase = 0; score = 0; cluesFound = 0;
    const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));
    let sfx;

    // --- Audio ---
    function initializeAudio() {
        sfx = {
            openCase: new Tone.Synth({ oscillator: { type: 'sawtooth' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.2 } }).toDestination(),
            clue: new Tone.MembraneSynth({ pitchDecay: 0.005, octaves: 10, envelope: { attack: 0.001, decay: 0.1, sustain: 0.01 } }).toDestination(),
            stamp: new Tone.NoiseSynth({ noise: { type: 'brown' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1 } }).toDestination(),
        };
    }
    
    function playSfx(type) {
        if (!sfx) return;
        if (Tone.context.state !== 'running') { Tone.start(); }
        if (type === 'openCase') sfx.openCase.triggerAttackRelease("G2", "8n");
        if (type === 'clue') sfx.clue.triggerAttackRelease("C5", "8n");
        if (type === 'stamp') sfx.stamp.triggerAttackRelease("0.2s");
    }

    // --- Unit 734 Controller ---
    const unit734 = {
        element: null,
        init() {  
            const existing = document.getElementById('unit-734');
            if(existing) existing.remove();
            scene.innerHTML += SVG_UNIT734;  
            this.element = document.getElementById('unit-734');  
            this.element.style.left = '-350px'; // Ensure it starts off-screen
            this.element.style.right = 'auto';
        },
        enter(position = 'right') {  
            if(!this.element) return;
            if (position === 'right') {
                this.element.style.left = 'auto';
                this.element.style.right = '20px';
            } else {
                this.element.style.right = 'auto';
                this.element.style.left = '50px';
            }
        },
        express(mood) {
            if (!this.element) return;
            this.element.querySelectorAll('.face').forEach(f => f.style.opacity = 0);
            this.element.querySelector(`#face-${mood}`).style.opacity = 1;
        },
        exit() {  
            if (!this.element) return;
            this.element.style.left = '-350px';  
            this.element.style.right = 'auto';
        }
    };
    
    // --- Typewriter Effect ---
    async function typewriter(element, text, speed = 30) {
        element.innerHTML = '';
        element.classList.add('typewriter-cursor');
        let i = 0;
        while (i < text.length) {
            if (text[i] === '<') {
                let tagEnd = text.indexOf('>', i);
                if (tagEnd !== -1) {
                    element.innerHTML += text.substring(i, tagEnd + 1);
                    i = tagEnd + 1;
                    continue;
                }
            }
            element.innerHTML += text[i];
            i++;
            await wait(speed);
        }
        element.classList.remove('typewriter-cursor');
    }
    
    function showPopup({ type, data, onclose }) {
        const overlay = document.createElement('div');
        overlay.className = 'absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center z-20';
        
        let popupHTML;
        if(type === 'email'){
             popupHTML = `<div class="p-4 bg-gray-100 rounded-t-lg border-b"><p class="font-bold text-gray-800">From: Manager</p><p class="text-sm text-gray-600">Subject: URGENT: Release Today</p></div><div class="p-6"><p class="text-gray-700">Team, the release MUST go out today, no exceptions! The stakeholders are waiting.</p></div><div class="p-4 bg-gray-50 rounded-b-lg text-right"><button id="close-popup-btn" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg">Log as Case Log</button></div>`;
        } else if (type === 'incorrect') {
            popupHTML = `<div class="p-4 bg-red-100 rounded-t-lg border-b border-red-300"><p class="font-bold text-red-800">That's not the right call.</p></div><div class="p-6"><p class="text-gray-700">${data.feedback}</p></div><div class="p-4 bg-gray-50 rounded-b-lg text-right"><button id="close-popup-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg">Try Another Lead</button></div>`;
        } else if (type === 'correct') {
            popupHTML = `<div class="p-4 bg-green-100 rounded-t-lg border-b border-green-300"><p class="font-bold text-green-800">Conclusion: Correct!</p></div><div class="p-6"><p class="text-gray-700">${data.feedback}</p></div><div class="p-4 bg-gray-50 rounded-b-lg text-right"><button id="close-popup-btn" class="bg-gray-800 text-white font-bold py-2 px-6 rounded-lg">Next Simulation</button></div>`;
        } else if (type === 'interrogation-continue') {
            popupHTML = `<div class="p-4 bg-green-100 rounded-t-lg border-b border-green-300"><p class="font-bold text-green-800">Evidence Gathered!</p></div><div class="p-6"><p class="text-gray-700">You have found all the evidence. Proceed to the interrogation.</p></div><div class="p-4 bg-gray-50 rounded-b-lg text-right"><button id="close-popup-btn" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg">Continue to Interrogation</button></div>`;
        }
        
        const popup = document.createElement('div');
        popup.className = 'popup-anim bg-white rounded-lg shadow-2xl w-full max-w-lg border-2 border-gray-300';
        popup.innerHTML = popupHTML;

        overlay.appendChild(popup);
        scene.appendChild(overlay);
        document.getElementById('close-popup-btn').addEventListener('click', () => {
            overlay.remove();
            if(onclose) onclose();
        }, { once: true });
    }

    // --- Game Flow ---
    async function startGame() {
        if (!sfx) initializeAudio();
        playSfx('openCase');
        startScreen.classList.add('hidden');
        endScreen.classList.add('hidden');
        gameScreen.classList.remove('hidden');
        currentCase = 0; score = 0;
        await loadIntro();
    }
    
    async function loadIntro() {
        scene.innerHTML = SCENE_SVGS.hq;
        unit734.init();
        caseDetails.innerHTML = `<h2 class="text-2xl font-bold text-indigo-700 mb-4" style="font-family: 'Special Agent', sans-serif;">System Boot</h2><div id="dialogue-box" class="space-y-4"></div>`;
        await wait(500);
        unit734.enter('left');  
        unit734.express('neutral');
        const dialogueBox = document.getElementById('dialogue-box');
        const p1 = document.createElement('p'); dialogueBox.appendChild(p1);
        await typewriter(p1, "Greetings. I am Unit 734, your assigned field analyst.");
        const p2 = document.createElement('p'); dialogueBox.appendChild(p2);
        await typewriter(p2, "My function is to assist you in upholding the JetBrains Code of Conduct.");
        const p3 = document.createElement('p'); dialogueBox.appendChild(p3);
        await typewriter(p3, "Our first case file is ready for review. Shall we proceed?");
        dialogueBox.innerHTML += `<button id="start-case-btn" class="mt-4 w-full bg-gray-800 text-white font-bold py-2 px-6 rounded-lg">Open Case File</button>`;
        document.getElementById('start-case-btn').onclick = async () => { unit734.exit(); await wait(800); loadCase(0); };
    }

    async function loadCase(index) {
        if(index >= caseFiles.length) {
            endGame();
            return;
        }
        const data = caseFiles[index];
        cluesFound = 0;
        scene.innerHTML = '';  
        if (data.sceneSVG) { scene.innerHTML = data.sceneSVG; }  
        else { scene.style.backgroundImage = data.sceneBg; }
        unit734.init();
        caseDetails.innerHTML = `<h2 class="text-2xl font-bold text-indigo-700 mb-4" style="font-family: 'Special Agent', sans-serif;">${data.title}</h2><div id="briefing-box" class="p-2 bg-blue-100 border border-blue-300 rounded text-sm mb-4"></div><div id="clue-log" class="space-y-2"></div>`;
        await wait(500); unit734.enter('right'); unit734.express('thinking');
        const briefingBox = document.getElementById('briefing-box');
        await typewriter(briefingBox, data.briefing);
        showInstructionPanel('Use the magnifying glasses to find evidence.');

        data.clues.forEach(clue => {
            const hotspot = document.createElement('div');
            hotspot.className = 'clue-hotspot'; hotspot.id = clue.id;
            hotspot.style.left = clue.x; hotspot.style.top = clue.y;
            hotspot.innerHTML = SVG_MAGNIFYING_GLASS;
            hotspot.onclick = () => findClue(clue, data.clues.length);
            scene.appendChild(hotspot);
        });
    }

    function showInstructionPanel(text) {
        let instructionPanel = document.getElementById('instruction-panel');
        if (!instructionPanel) {
            instructionPanel = document.createElement('div');
            instructionPanel.id = 'instruction-panel';
            instructionPanel.className = 'absolute bg-yellow-200 p-2 rounded-lg shadow-lg border-2 border-yellow-400 text-center opacity-75';
            scene.appendChild(instructionPanel);
        }
        instructionPanel.style.display = 'block';
        instructionPanel.innerHTML = `<p class="font-bold text-yellow-800 text-sm">${text}</p>`;
    }
    
    function hideInstructionPanel() {
        const instructionPanel = document.getElementById('instruction-panel');
        if (instructionPanel) {
            instructionPanel.style.display = 'none';
        }
    }


    function findClue(clueData, totalClues) {
        hideInstructionPanel();

        const hotspot = document.getElementById(clueData.id);
        if (hotspot.classList.contains('found')) return;
        
        const logEvidence = () => {
            hotspot.style.animation = 'clue-fade-out 0.3s ease-out forwards';
            setTimeout(() => hotspot.remove(), 300);
            cluesFound++;
            const clueLog = document.getElementById('clue-log');
            clueLog.innerHTML += `<p class="p-2 bg-yellow-100 border border-yellow-300 rounded text-sm pop-in">${clueData.evidence}</p>`;
            caseDetails.scrollTop = caseDetails.scrollHeight;
            
            if (cluesFound === totalClues) {
                unit734.express('neutral');
                showPopup({
                    type: 'interrogation-continue',
                    onclose: () => {
                        presentInterrogation(caseFiles[currentCase]);
                    }
                });
            } else {
                showInstructionPanel('Find the remaining evidence.');
            }
        };

        if(clueData.type === 'email'){ 
            showPopup({ type: 'email', data: clueData, onclose: logEvidence });
        } else { 
            logEvidence(); 
        }
    }
    
    async function presentInterrogation(data) {
        caseDetails.innerHTML = `<h2 class="text-2xl font-bold text-indigo-700 mb-4" style="font-family: 'Special Agent', sans-serif;">${data.title}</h2><p class="text-sm font-bold text-gray-700 mt-2">Score: ${score}/${currentCase+1}</p>`;
        await wait(500);
        const interrogationEl = document.createElement('div');
        interrogationEl.className = 'mt-4 p-2';
        caseDetails.appendChild(interrogationEl);

        const titleEl = document.createElement('p');
        titleEl.className = 'text-sm font-bold text-gray-700 mt-2';
        interrogationEl.appendChild(titleEl);
        await typewriter(titleEl, 'CONNECT THE CLUES:');
        
        const promptEl = document.createElement('p');
        promptEl.className = 'mt-2 text-gray-800 italic';
        interrogationEl.appendChild(promptEl);
        await typewriter(promptEl, `Suspect says: "${data.interrogation}"`);

        const questionEl = document.createElement('p');
        questionEl.className = 'mt-4 font-bold text-indigo-700';
        interrogationEl.appendChild(questionEl);
        await typewriter(questionEl, "How do you respond, Detective?");

        const choicesContainer = document.createElement('div');
        choicesContainer.id = 'choices-container'; choicesContainer.className = 'mt-2 space-y-2';
        interrogationEl.appendChild(choicesContainer);
        data.choices.forEach(choice => {
            const button = document.createElement('button');
            button.className = 'choice-btn w-full p-3 rounded-lg text-left font-semibold';
            button.textContent = choice.text;
            button.onclick = (e) => handleChoice(choice, e.currentTarget);
            choicesContainer.appendChild(button);
        });
        caseDetails.scrollTop = caseDetails.scrollHeight;
    }

    async function handleChoice(choice, buttonEl) {
        if (choice.correct) {
            document.querySelectorAll('.choice-btn').forEach(btn => btn.classList.add('disabled'));
            score++; unit734.express('happy');
            
            showPopup({type: 'correct', data: choice, onclose: async () => {  
                unit734.exit();  
                await wait(800);  
                currentCase++;
                loadCase(currentCase);
            }});
        } else {
            buttonEl.classList.add('disabled', 'incorrect-choice');
            unit734.express('worried');
            showPopup({type: 'incorrect', data: choice});
        }
    }
    
    function endGame() {
        gameScreen.classList.add('hidden');
        endScreen.classList.remove('hidden');
        document.getElementById('end-message').textContent = `You correctly solved ${score} out of ${caseFiles.length} cases.`;
        const passwordContainer = document.getElementById('password-container');
        if (score === caseFiles.length) { 
            passwordContainer.classList.remove('hidden'); 
            lmsInstructions.classList.remove('hidden');
        }  
        else { 
            passwordContainer.classList.add('hidden');
            lmsInstructions.classList.add('hidden');
        }
    }

    // --- Initializer ---
    startBtn.addEventListener('click', startGame);
    restartBtn.addEventListener('click', startGame);
});
</script>
</body>
</html>
